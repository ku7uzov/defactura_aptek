{% extends 'base.html' %}

{% block title %} –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö {% endblock %}

{% block content %}
 <div class="col-md-12 mb-lg-0 mb-4">
            <div class="card mt-4 shadow-sm border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h6 class="mb-0" style="color:white;">üìà –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö</h6>
    </div>
                <div class="card-body">
                    <h5> –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–∞–π–ª —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Ñ–∞—Ä–º–∞—Ü–µ–≤—Ç–æ–≤</h5>
                  <div class="row">
                     <form id="file-upload-form" class="form-control" method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        <input type="file" name="file" id="file" required class="btn bg-gradient-white mb-0">
                        <button type="submit" class="btn bg-gradient-success mb-0">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                     </form>
                  </div>
                </div>
              </div>
            </div>
<div id="loader" style="display:none;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
<div id="error-message" style="display:none;"></div>

{% endblock %}

{% block scripts %}
<script>
document.getElementById('file-upload-form').addEventListener('submit', function(event) {
    event.preventDefault(); // –û—Ç–º–µ–Ω—è–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Ñ–æ—Ä–º—ã

    const formData = new FormData(this); // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
    const loader = document.getElementById('loader');
    const errorMessage = document.getElementById('error-message');

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∞–¥–µ—Ä
    loader.style.display = 'flex';
    errorMessage.style.display = 'none';

    fetch('/sort-file/', {
        method: 'POST',
        body: formData,
    })
    .then(response => response.blob())
    .then(blob => {
        // –°–∫—Ä—ã—Ç—å –ª–æ–∞–¥–µ—Ä
        loader.style.display = 'none';

        // –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
        const downloadLink = document.createElement('a');
        downloadLink.href = URL.createObjectURL(blob);
        downloadLink.download = 'sorted_file.csv';  // –ò–∑–º–µ–Ω–µ–Ω–æ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ –Ω–∞ .csv
        downloadLink.click();
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
        loader.style.display = 'none';
        errorMessage.style.display = 'block';
        errorMessage.textContent = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞.';
    });
});
</script>
{% endblock %}
