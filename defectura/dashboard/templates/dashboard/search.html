{% extends 'base.html' %}

{% block title %}–ü–æ–∏—Å–∫ –¥–µ—Ñ–µ–∫—Ç—É—Ä—ã{% endblock %}

{% block content %}
<div class="col-md-12 mb-4">
  <div class="card mt-4 shadow-sm border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h6 class="mb-0" style="color: white">üîé –ü–æ–∏—Å–∫ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –ø–æ –∞–ø—Ç–µ–∫–∞–º</h6>
    </div>

    <div class="card-body">
      <form method="get" action="{% url 'dashboard' %}" id="search-form" class="row g-2 align-items-center">
        <div class="col-md-8">
          <input type="text" class="form-control form-control-lg" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞ –∏–ª–∏ –ú–ù–ù" name="query" id="query" value="{{ query }}">
        </div>
        <div class="col-md-2">
          <button class="btn btn-success w-100" type="submit">üîç –ü–æ–∏—Å–∫</button>
        </div>
      </form>
    </div>
  </div>

  <div class="card mt-4 shadow-sm border-0">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h6 class="mb-0">üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h6>
    </div>
    <div class="card-body">
      <div id="results">
        <!-- –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
      </div>
    </div>
  </div>
</div>


{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const searchForm = document.getElementById("search-form");
    const queryInput = document.getElementById("query");
    const overlay = document.getElementById("overlay");
    const resultsContainer = document.getElementById("results");

    searchForm.addEventListener("submit", function (event) {
      event.preventDefault();

      const query = queryInput.value.trim();
      if (!query) return;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º overlay
      overlay.style.display = "flex";

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å
      fetch(`/search/tablets/?query=${encodeURIComponent(query)}&selected-region=0`, {
        method: "GET",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
        .then(response => response.text())
        .then(html => {
          resultsContainer.innerHTML = html;
        })
        .catch(error => {
          resultsContainer.innerHTML = `<div class="alert alert-danger">–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö.</div>`;
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
        })
        .finally(() => {
          // –ü—Ä—è—á–µ–º overlay –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
          overlay.style.display = "none";
        });
    });
  });
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const overlay = document.getElementById("overlay");

    // –ü–µ—Ä–µ—Ö–≤–∞—Ç —Ñ–æ—Ä–º—ã –ø–æ–∏—Å–∫–∞ ‚Äî —É–∂–µ –µ—Å—Ç—å
    const searchForm = document.getElementById("search-form");
    const queryInput = document.getElementById("query");
    const resultsContainer = document.getElementById("results");

    // üîÑ –ü–µ—Ä–µ—Ö–≤–∞—Ç –≤—Å–µ—Ö —Ñ–æ—Ä–º —Å –∫–ª–∞—Å—Å–æ–º "download-form"
    document.addEventListener("submit", function (event) {
      const form = event.target;

      if (form.classList.contains("download-form")) {
        event.preventDefault();

        const url = form.getAttribute("data-url");
        const formData = new FormData(form);
        const tabletName = form.querySelector('input[name="name"]').value;

        overlay.style.display = "flex";

        fetch(url, {
          method: "POST",
          headers: {
            "X-Requested-With": "XMLHttpRequest",
            "X-CSRFToken": form.querySelector('input[name=csrfmiddlewaretoken]').value
          },
          body: formData,
        })
        .then(response => {
          if (!response.ok) {
            throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞.");
          }

          return response.blob();
        })
        .then(blob => {
          const downloadUrl = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = downloadUrl;
          a.download = `${tabletName}.csv`;  // –ò–ª–∏ –ø–æ–ª—É—á–∏ –∏–∑ response.headers, –µ—Å–ª–∏ –Ω–∞–¥–æ
          document.body.appendChild(a);
          a.click();
          a.remove();
          window.URL.revokeObjectURL(downloadUrl);
        })
        .catch(error => {
          alert("–û—à–∏–±–∫–∞: " + error.message);
        })
        .finally(() => {
          overlay.style.display = "none";
        });
      }
    });
  });
</script>


{% endblock %}

<style>
  /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞ */
  .overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }

  .spinner-border {
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite; /* –ê–Ω–∏–º–∞—Ü–∏—è –≤—Ä–∞—â–µ–Ω–∏—è */
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–∫–∞—á–∞—Ç—å" */
  .btn {
    background-color: #007bff;
    color: white;
    font-size: 16px;
    padding: 12px 20px;
    border-radius: 5px;
    border: none;
    cursor: pointer;
  }

  .btn:hover {
    background-color: #0056b3;
  }

  /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü */
  table {
    width: 100%;
    margin-top: 20px;
    border-collapse: collapse;
  }

  table th, table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }

  table th {
    background-color: #f8f9fa;
  }

  table td {
    background-color: #fff;
  }

  .table-responsive {
    overflow-x: auto;
  }
</style>
