{% extends 'base.html' %}

{% block title %}–ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–∞{% endblock %}

{% block content %}
<div class="col-md-12 mb-4">
  <div class="card mt-4 shadow-sm border-0">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <h6 class="mb-0" style="color: white">üìà –î–∏–Ω–∞–º–∏–∫–∞ –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π</h6>
    </div>

    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>–ü—Ä–µ–ø–∞—Ä–∞—Ç</th>
              <th>–ò–∑–º–µ–Ω–µ–Ω–∏—è</th>
              <th>–î–∞—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤</th>
              <th>–î–µ—Ç–∞–ª–∏</th>
            </tr>
          </thead>
          <tbody>
            {% for change in drug_changes %}
            <tr>
              <td class="fw-semibold">{{ change.drug_name }}</td>

              <td>
                <div>
                  <span class="me-1">–ë–µ–∑ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞:</span>
                  {% if change.pharmacies_without_diff > 0 %}
                    <span class="text-success fw-bold">‚ñ≤ {{ change.pharmacies_without_diff }}</span>
                  {% elif change.pharmacies_without_diff < 0 %}
                    <span class="text-danger fw-bold">‚ñº {{ change.pharmacies_without_diff }}</span>
                  {% else %}
                    <span class="text-muted">‚Äî</span>
                  {% endif %}
                </div>
              </td>

              <td>
                <small class="text-muted">–ü–æ—Å–ª–µ–¥–Ω–∏–π: {{ change.searched_at|date:"Y-m-d H:i" }}</small><br>
                <small class="text-muted">–î–æ —ç—Ç–æ–≥–æ: {{ change.previous_searched_at|date:"Y-m-d H:i" }}</small>
              </td>

              <td>
                <a href="{% url 'drug_chart' change.drug_id %}" class="btn btn-outline-secondary btn-sm">
                  –ò—Å—Ç–æ—Ä–∏—è: {{ change.drug_name }}
                </a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center text-muted py-4">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>
 <div class="col-lg-12 mb-lg-0 mb-4">
        <div class="card">
            <div class="card-header pb-0 p-3">
                <div class="d-flex justify-content-between">
                    <h6 class="mb-2">–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∞–ø—Ç–µ–∫ –±–µ–∑ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞</h6>
                </div>
            </div>
            <div class="table-responsive">
                <canvas id="drugChangesChart"></canvas>
            </div>
        </div>
    </div>

<div id="loader" style="display:none;"></div>
  <style>
    #drugChangesChart {
        width: 50% !important;  /* –£–º–µ–Ω—å—à–∞–µ–º —à–∏—Ä–∏–Ω—É –¥–æ 50% –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
        height: 450px !important; /* –£–º–µ–Ω—å—à–∞–µ–º –≤—ã—Å–æ—Ç—É –¥–æ 250px */
    }
</style>
{% endblock %}

{% block scripts %}
<script>
  var ctx = document.getElementById('drugChangesChart').getContext('2d');

// –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –º–µ—Ç–∫–∏ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
var labels = {{ chart_labels|safe }};
var data = {{ chart_data|safe }};

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç–∞ –¥–ª—è —Å—Ç–æ–ª–±—Ü–æ–≤: –µ—Å–ª–∏ –¥–∏–Ω–∞–º–∏–∫–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–∞—è - –∑–µ–ª–µ–Ω—ã–π, –µ—Å–ª–∏ –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è - –∫—Ä–∞—Å–Ω—ã–π
var backgroundColors = data.map(function(value) {
    return value >= 0 ? 'rgba(75, 192, 192, 0.2)' : 'rgba(255, 99, 132, 0.2)';
});

var borderColors = data.map(function(value) {
    return value >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)';
});

var drugChangesChart = new Chart(ctx, {
    type: 'bar', // –¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞
    data: {
        labels: labels, // –ú–µ—Ç–∫–∏ (–Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–≤)
        datasets: [{
            label: '–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–ø—Ç–µ–∫ –±–µ–∑ –ø—Ä–µ–ø–∞—Ä–∞—Ç–∞',
            data: data, // –î–∞–Ω–Ω—ã–µ (—Ä–∞–∑–Ω–∏—Ü–∞ –≤ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∞–ø—Ç–µ–∫)
            backgroundColor: backgroundColors, // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ü–≤–µ—Ç–∞
            borderColor: borderColors, // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ —Ü–≤–µ—Ç–∞ –¥–ª—è –≥—Ä–∞–Ω–∏—Ü—ã
            borderWidth: 1
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

</script>
<!-- –°–∫—Ä–∏–ø—Ç—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ -->
{% endblock %}
